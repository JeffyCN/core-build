#! /bin/sh -e
# initramfs local-premount script to install from recovery

PREREQ=""

# Output pre-requisites
prereqs()
{
        echo "$PREREQ"
}

case "$1" in
    prereqs)
        prereqs
        exit 0
        ;;
esac


for x in $(cat /proc/cmdline); do
    case $x in
        snap_mode=*)
            snap_mode=${x#*=}
            ;;
        snap_recovery_system=*)
            recovery=${x#*=}
            echo "System recovery set to $recovery"
            ;;
    esac
done


# Only prepare writable on tmpfs in these three modes

if [ "$snap_mode" != "install" ] && [ "$snap_mode" != "recover" ] && [ "$snap_mode" != "recover_reboot" ]; then
    exit 0
fi


ubuntu_seed_part="$(findfs LABEL=ubuntu-seed || true)"
ubuntu_boot_part="$(findfs LABEL=ubuntu-boot || true)"

syspath="$(dirname "$(realpath /sys/class/block/"$(basename "$ubuntu_seed_part")")")"
device="$(realpath /dev/block/"$(cat "$syspath"/dev)")"


create_writable_on_tmpfs() {
    echo "Create writable"
    mkdir /ubuntu-seed /writable /ubuntu-boot
    mount -t vfat "$ubuntu_seed_part" /ubuntu-seed
    mount -t vfat "$ubuntu_boot_part" /ubuntu-boot
    mount -t tmpfs tmpfs /writable
    mkdir -p /writable/"$seed_path"
    mkdir -p /writable/"$snaps_path"
    mkdir -p /writable/system-data/boot
    echo "bind mount recovery"
    mount -o bind "$recovery_path" /writable/"$seed_path"
    echo "bind mount snap direcotry"
    mkdir /writable/"$seed_path"/snaps
    mount -o bind "$recovery_root"/snaps /writable/"$seed_path"/snaps
    
    echo "create symlinks"
    snap_core=$(basename $(echo "$recovery_root"/snaps/core20_*.snap|tail -1))
    # fugly - hardcoded kernel name :( we need this so that the grub-bootenv
    # kernel name matches the kernel that is later seeded
    snap_kernel=$(basename $(echo "$recovery_root"/snaps/pc-kernel_*.snap|tail -1))
    ln -s ../seed/snaps/"$snap_core" /writable/"$snaps_path"
    ln -s ../seed/snaps/"$snap_kernel" /writable/"$snaps_path"
    echo "done"
}

update_grub() {
    echo "Update grub"
    system_boot_grubenv="/ubuntu-boot/EFI/ubuntu/grubenv"
    sys_recover_grubenv="/ubuntu-seed/EFI/ubuntu/grubenv"
    mkdir -p $(dirname "$system_boot_grubenv")

    # snapd needs this (will be bind-mounted on /boot/grub later)
    grub-editenv "$system_boot_grubenv" create
    grub-editenv "$system_boot_grubenv" set snap_core="core20_x1.snap"
    grub-editenv "$system_boot_grubenv" set snap_kernel="pc-kernel_x1.snap"

    umount /ubuntu-seed
    umount /ubuntu-boot
}


recovery_root="/ubuntu-seed/"
recovery_path="$recovery_root/systems/$recovery"
seed_path="/system-data/var/lib/snapd/seed"
snaps_path="/system-data/var/lib/snapd/snaps"

create_writable_on_tmpfs
update_grub

umount /writable

sync

